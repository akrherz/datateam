<?php 
require_once "../../../include/require_auth.php";

function build_treatments_ui(){
	$pgconn = pg_connect("dbname=sustainablecorn host=iemdb user=nobody");
	$rs = pg_query($pgconn, "select code_column_heading, short_description ".
			"from cscap_data_dictionary where ".
			"substr(code_column_heading, 1, 3) in ('ROT', 'TIL', 'HER',".
			"'NIT', 'DWM', 'LND')".
			"ORDER by short_description");
	$s = '';
	for ($i=0; $row=@pg_fetch_assoc($rs, $i); $i++){
		$s .= sprintf("<input type=\"checkbox\" value=\"%s\"".
				" data-treatment=\"%s\" name=\"treatments[]\">%s\n",
				$row['code_column_heading'],
				$row['code_column_heading'], $row['short_description']);
	}
	return $s;
}

function build_agronomic_ui(){
	$pgconn = pg_connect("dbname=sustainablecorn host=iemdb user=nobody");
	$rs = pg_query($pgconn, "select code_column_heading, short_description ".
			"from cscap_data_dictionary where ".
			"substr(code_column_heading, 1, 3) = 'AGR' ".
			"ORDER by short_description");
	$s = '';
	for ($i=0; $row=@pg_fetch_assoc($rs, $i); $i++){
		$s .= sprintf("<input type=\"checkbox\" value=\"%s\"".
				" data-agronomic=\"%s\" name=\"agronomic[]\">%s\n",
				$row['code_column_heading'],
				$row['code_column_heading'], $row['short_description']);
	}
	return $s;
}

function build_soil_ui(){
	$pgconn = pg_connect("dbname=sustainablecorn host=iemdb user=nobody");
	$rs = pg_query($pgconn, "select code_column_heading, short_description ".
			"from cscap_data_dictionary where ".
			"substr(code_column_heading, 1, 4) = 'SOIL' ".
			"ORDER by short_description");
	$s = '';
	for ($i=0; $row=@pg_fetch_assoc($rs, $i); $i++){
		$s .= sprintf("<input type=\"checkbox\" value=\"%s\"".
				" data-soil=\"%s\" name=\"soil[]\">%s\n",
				$row['code_column_heading'],
				$row['code_column_heading'], $row['short_description']);
	}
	return $s;
}

function build_sites_ui(){
	$states = Array("IA" => "Iowa",
		"MN" => "Minnesota",
		"WI" => "Wisconsin",
		"IL" => "Illinois",
		"MO" => "Missouri",
		"IN" => "Indiana",
		"MI" => "Michigan",
		"OH" => "Ohio");
	$pgconn = pg_connect("dbname=mesosite host=iemdb user=nobody");
	$rs = pg_query($pgconn, "SELECT * from stations where network = 'CSCAP'".
			" ORDER by name ASC");
	$data = Array();
	for ($i=0; $row=@pg_fetch_assoc($rs, $i); $i++){
		$data[$row["state"]][$row["id"]] = $row["name"];
	}
	$keys = array_keys($data);
	asort($keys);
	$s = '';
	$q = -1;
	while (list($v,$k)=each($keys)){
		$q += 1;
		if ($q % 3 == 0){
			$s .= "<div class=\"col-md-4\">\n";
		}
		$s .= sprintf("<h3><input type=\"checkbox\" class=\"state-check\"".
				" value=\"%s\">%s</h3>\n", $k, $states[$k]);
		while (list($v2, $k2)=each($data[$k])){
			$s .= sprintf("<br /><input type=\"checkbox\" value=\"%s\"".
					" data-state=\"%s\" name=\"sites[]\" class=\"site-check\"".
					">%s\n", $v2, $k, $k2);
		}
		if ($q % 3 == 2){
			$s .= "</div>\n";
		}
	}
	if ($q % 3 != 2){
		$s .= "</div>\n";
	}
	return $s;
}

function build_year_ui(){
	$years = Array(2011, 2012, 2013, 2014, 2015);
	$s = '';
	while (list($k, $v)=@each($years)){
		$s .= sprintf("<input type=\"checkbox\" value=\"%s\"".
				" data-year=\"%s\" name=\"year[]\">%s\n",
				$v, $v, $v);
	}
	return $s;
}

require_once "../../../include/myview.php";
$t = new MyView();
$t->title = "CSCAP Project Data Download";
$t->headextra = <<<EOF
<link rel="stylesheet" href="/vendor/jquery-ui/1.11.4/jquery-ui.css" />
<link rel="stylesheet" href="/vendor/jquery-ui/1.11.4/jquery-ui.theme.css" />
EOF;
$t->jsextra = <<<EOF
<script src="/vendor/jquery-ui/1.11.4/jquery-ui.js"></script>
<script src="dl.js"></script>
EOF;

$sitesui = build_sites_ui();
$treatmentui = build_treatments_ui();
$agronomicui = build_agronomic_ui();
$soilui = build_soil_ui();
$yearui = build_year_ui();

$t->content = <<<EOF

<h3>CSCAP Data Download</h3>

<form method="POST" action="dl.py">
<div class="btn-group" role="group" aria-label="Pages">
  <button type="button" class="btn btn-primary" id="sites-btn">Sites</button>
  <button type="button" class="btn btn-default" id="treatments-btn">Treatments</button>
  <button type="button" class="btn btn-default" id="agronomic-btn">Agronomic</button>
  <button type="button" class="btn btn-default" id="soil-btn">Soil</button>
  <button type="button" class="btn btn-default" id="year-btn">Year</button>
  <button type="button" class="btn btn-default" id="option-btn">Final Options</button>
</div>

<div id="sites-ui" style="display: block;">
{$sitesui}
</div>
<div id="treatments-ui" style="display: none;">
	<h3>Treatments</h3>
{$treatmentui}
</div>
<div id="agronomic-ui" style="display: none;">
	<h3>Agronomic</h3>
{$agronomicui}
</div>
<div id="soil-ui" style="display: none;">
	<h3>Soil</h3>
{$soilui}
</div>
<div id="year-ui" style="display: none;">
	<h3>Years</h3>
{$yearui}
</div>
<div id="option-ui" style="display: none;">
	<h3>Final Options</h3>

<p>How to handle values below detection limit:
<select name="detectlimit">
	<option value="1">Keep them as is, presented as "&lt; LOD"</option>
	<option value="2">Divide the LOD value by two</option>
	<option value="3">Divide the LOD value by square root of two</option>
	<option value="4">Omit all occurrences and replace as missing</option>
</select>
		
	<input type="submit" value="Proceed with Download">
</div>
</form>
		
		
<br clear="both" />
<div class="pull-right">
<button id="prev-btn" type="button" class="btn btn-default"><i class="glyphicon glyphicon-arrow-left"></i> Previous</button>
<button id="next-btn" type="button" class="btn btn-default">Next <i class="glyphicon glyphicon-arrow-right"></i></button>
</div>
EOF;
$t->render('single.phtml');

?>